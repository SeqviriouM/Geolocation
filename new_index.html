<!DOCTYPE html>
<html>
  <head>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <title>Геолокация</title>

    <style>
      body {
        background-color: #8B00FF;
        margin-top:200px;
      }

      .left {
        background-color: white;
        float:left;
        position:relative;
        left:50%;
      }

      .right {
        background-color: white;
        position:relative;
        right:50%;
      }

      .middle {
        background-color: white;
        margin: 0 auto;
        width: 500px;

      } 

      .form_class {
        padding:20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .next {
        float:right;
        margin-right: 20px;
      }

    </style>


  </head>

  <body>

    <div class="middle">
        
        <form class="form_class" name="form" id="form">
          <div class="form-group">
            <div style="text-align: center">
              <b><label>Заполните следующие поля</label></b>
            </div>
          </div>
          <div class="form-group">
            <label>От: </label>
            <input type="text" name="from" id="from" placeholder="Место отправления" size=25>
          </div>
          <div class="form-group">
            <label>До: </label>
            <input type="text" name="to" id="to" placeholder="Место прибытия" size=25>
          </div>
          <div class="form-group">
            <label>Вид транспорта: </label>
          </div>
          <div class="form-group">
            <input type="radio" name="transport" value="airplane">Самолет
            <input type="radio" name="transport" value="train">Поезд
            <input type="radio" name="transport" value="ship">Корабль
            <input type="radio" name="transport" value="bus">Автобус<br><br>
            <input type="radio" name="transport" value="another">Другой вид транспорта:  
            <input type="text" placeholder="Название транспорта" id="another_transport" name="another_transport" size=25 disabled>
          </div>
          
          <div class="form-group">
            <label>Информация по маршруту: </label>
            <br><br>
            <div id="dop_info">
              <div  id="group_info0">
                <input type="text" id="property0" name="property0" placeholder="Название свойства">: 
                <input type="text" id="value0" name="value0" placeholder="Значение">
                <br><br>
              </div>
            </div>
            <br>
            <input type="button" value="Добавить поле" onclick="add()">
             <input type="button" value="Удалить поле" onclick="del()">
          </div>
          <div class="form-group">
            <input type="button" value="Ввести еще данные" onclick="save()">
            <input type="button" value="Далее" class="next" onclick="next()" >
          </div>
        </form>
    
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

    <script>

  var c = 1; // номер вновь созданного текстового поля

  // Обработка событий изменнения значений radio и checkbox 
    $(function(){
    // Активация текстового поля для ввода названия транспорта при выборе варианта "Другой вид транспорта"
    $('input[name=transport]:radio').change(function() {
      if (this.value === "another") {
        $('#another_transport').prop('disabled', false);
      } else {
        $('#another_transport').prop('disabled', true);
      }
    }); 
  })     

  // Функция удаления ненужных полей(вызывается при нажатии кнопки "Удалить поле")
  function del() {
    c--;
    if (c > 0) {
      $('#group_info' + c).remove();
        
    } else {
      c++;
    }
     
  }
  
  // Функция добавления поля(вызывается при нажатии кнопки "Добавить поле") 
  function add() {
    $('#dop_info').append('<div  id="group_info'+ c + '"><input type="text" id="property'+ c + '" name="property' + c + '" placeholder="Название свойства">: <input type="text" id="value' + c + '" name="value' + c +'" placeholder="Значение"><br><br></div>');
    c++;

  }
  </script>

  <script>
    
    var data={}; // Содержит всю введенную информацию по маршруту

    // Функция сохранения текущей карточки и подготовка к вводу новой
    function save() {
      
      var trip = {}; // Содержит текущий отрезок
      var result_check; // Содержит результат проверки
      var from = document.getElementById("from").value; // Получение точки отправления
      var to = document.getElementById("to").value; // Получение точки прибытия
      var info_route = {}; // Содержит информацию о текущем отрезке пути
      var property=""; // Переменная для хранения промежуточного значения имени свойства
      var transport = document.form.transport.value; // Получение вида транспорта
      
      // Если выбран пункт "Другой транспорт", то считать имя транспорта из текстового поля
      if (transport === "another") {
          transport = document.getElementById("another_transport").value;
      }

      if (transport !== "") {
        trip["transport"] = transport;
      }

      // Получение div с id=dop_info
      var div = document.getElementById("dop_info");
      // Получение всех элементов input входящих в этот div
      var elems = div.getElementsByTagName('input');

      for(var i=0; i<elems.length; i++) {
        if (elems[i].value !== "") {
          property = elems[i].value;
          i++;
          if (elems[i].value !== "") {
            trip[property] = elems[i].value;
          } 
          property = "";
        } else {
          i++;
        }
      }
      

      // Проверка на ввод пустого места отправления    
      if (from === "") {
        alert("Ошибка. Вы забыли заполнить поле 'Место отправления'");
        return;
      }

      // Проверка на ввод пустого места прибытия
      if (to === "") {
        alert("Ошибка. Вы забыли заполнить поле 'Место прибытия'");
        return;
      }

      trip["from"] = from;
      trip["to"] = to;
        
      if (typeof data[from] === "undefined") {
        data[from] = trip; // Добавление введенного отрезка к информации по маршруту  
      } else {
        alert("Ошибка. В введенном маршруте встречается 2 одинаковых города");
        return;
      }
      
      console.log(trip);

      //data.push(trip); // Добавление к информации по маршруту введенного отрезка

      // document.getElementById("from").value="";
      // document.getElementById("to").value="";

      // Очищение формы
      document.getElementById("form").reset();
    }

    function next() {
      
      console.log(data);

      var kol_gorod = {}; // Содержит кол-во встречаемости каждого города.
      var begin; // Начало маршрута
      var end; // Конец маршрута
      var result=""; // Будет содержать конечное словесное описание маршрута
      
      // Определения кол-ва встречаемости городов. Каждый город должен быть упомянут дважды: как пункт отправления и как пункт прибытия, за исключения начального города и конечного города. 
      for (var i in data) {
        if (typeof kol_gorod[data[i].to] === "undefined") {
          kol_gorod[data[i].to] = 1;
        } else {
          kol_gorod[data[i].to]++;
        }

        if (typeof kol_gorod[data[i].from] === "undefined") {
          kol_gorod[data[i].from] = 1;
        } else {
          kol_gorod[data[i].from]++;
        } 
      }
      
      // Выполним проверку введенного маршрута
      var result_check = check_route(kol_gorod);

      if(!result_check) {
        alert("Введенный маршрут некорректен. Попробуйте ввести данные заново.");
        return;
      }

      if (typeof data[result_check[0]] === "undefined") {
        begin = result_check[1];
        end = result_check[0];
      } else {
        begin = result_check[0];
        end = result_check[1];
      }
      
      console.log(Object.keys(data).length);

      result = begin + " - ";

      for (var i=0; i<Object.keys(data).length; i++) {
        result += data[begin].to + " - ";
        begin = data[begin].to;
      }

      console.log(result);
    }

    // Функция проверки корректности введенного маршрута
    function check_route(towns) {
      var kol = 0; // Кол-во городов, встречающихся нечетное кол-во раз(это должен быть город начала пути и город окончания путешествия)
      var lateral_position = []; // Содержит крайние позиции, т.е. начальную точку отправления и конечную точку прибытия
      var check = true; // Сообщает результат проверки. В случае корректного ввода маршрута check = true 
      var result=[]; // Будет содержать заключение проверки и вслучае успеха два крайних города

      // Проверка, что данный город в маршруте фигурирует четное число раза(кроме крайних позиций)
      for (var i in towns) {
        if(towns[i] % 2 === 0) {
          continue;
        } else {
          if (kol < 2) {
            lateral_position.push(i);
            kol++;
          } else {
            check = false;
          }
        }
      }

      console.log(lateral_position);

      if (check) {        
        return lateral_position;
      } else {
        return false;
      }
    }
    </script>

  </body>
</html>
